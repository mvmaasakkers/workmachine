---
# Main playbook for development environment setup
# This playbook configures a fresh Ubuntu/Debian server with all necessary development tools

- name: Configure development environment
  hosts: all
  gather_facts: true
  vars_files:
    - ../vars.yml

  pre_tasks:
    - name: Display target host information
      ansible.builtin.debug:
        msg: |
          Setting up development environment on:
          - Host: {{ inventory_hostname }}
          - OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - Architecture: {{ ansible_architecture }}

    - name: Ensure system is supported
      ansible.builtin.assert:
        that:
          - ansible_os_family in ["Debian", "Darwin"]
        fail_msg: "This playbook only supports Debian/Ubuntu/Pop!_OS and macOS systems"
        success_msg: "Compatible OS detected: {{ ansible_distribution }}"

    - name: Update apt cache (Linux)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      become: true
      when: ansible_os_family == "Debian"

    - name: Ensure Homebrew is installed (macOS)
      ansible.builtin.stat:
        path: "{{ homebrew_prefix }}/bin/brew"
      register: homebrew_installed
      when: ansible_os_family == "Darwin"

    - name: Display Homebrew warning if not installed (macOS)
      ansible.builtin.fail:
        msg: |
          Homebrew is not installed. Please install it first:
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      when: ansible_os_family == "Darwin" and not homebrew_installed.stat.exists

  roles:
    - role: common
      tags: ['common', 'base']

    - role: zsh
      tags: ['zsh', 'shell']

    - role: alacritty
      tags: ['alacritty', 'terminal', 'shell']

    - role: docker
      tags: ['docker', 'containers']

    - role: nvim
      tags: ['nvim', 'editor']

    - role: php
      tags: ['php', 'languages']

    - role: go
      tags: ['go', 'golang', 'languages']

    - role: nodejs
      tags: ['nodejs', 'node', 'npm', 'languages']

    - role: python
      tags: ['python', 'pip', 'languages']

    - role: netbird
      tags: ['netbird', 'vpn', 'networking']

    - role: github-cli
      tags: ['github-cli', 'gh', 'tools']

    - role: claude-code
      tags: ['claude-code', 'claude', 'ai', 'tools']

    - role: opencode
      tags: ['opencode', 'ai', 'tools']

    - role: devpod
      tags: ['devpod', 'containers', 'tools']

  post_tasks:
    - name: Display setup completion message
      ansible.builtin.debug:
        msg: |
          ========================================
          Development environment setup complete!
          ========================================

          Installed tools:
          - Common utilities: git, curl, wget, tmux, btop
          - Shell: zsh with oh-my-zsh, Nerd Fonts
          - Terminal: Alacritty
          - Container platform: Docker with Docker Compose
          - Editor: Neovim with plugins
          - Languages: PHP {{ php_version }}, Go {{ go_version }}, Node.js {{ nodejs_version }}, Python 3
          - Package managers: composer, npm, pip, bun
          - VPN: Netbird client (not connected)
          - CLI tools: GitHub CLI (gh), Claude Code CLI, OpenCode CLI

          Next steps:
          1. Log out and back in for group changes (docker) to take effect
          2. Start a new zsh session: exec zsh
          3. Verify installations with: docker --version, go version, node --version, php --version
          4. Authenticate GitHub CLI: gh auth login
          5. Authenticate Claude Code: claude login
          6. Configure OpenCode: opencode

          Happy coding!

    - name: Remind about group membership
      ansible.builtin.debug:
        msg: "IMPORTANT: You may need to log out and back in for docker group membership to take effect"
