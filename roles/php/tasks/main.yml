---
# PHP role - Install PHP CLI and Composer

- name: Add Ondrej PHP PPA (Ubuntu/Pop!_OS)
  ansible.builtin.apt_repository:
    repo: ppa:ondrej/php
    state: present
  become: true
  when: ansible_distribution in ["Ubuntu", "Pop!_OS"]

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: ansible_os_family == "Debian"

- name: Install PHP and common extensions
  ansible.builtin.package:
    name:
      - "php{{ php_version }}-cli"
      - "php{{ php_version }}-common"
      - "php{{ php_version }}-curl"
      - "php{{ php_version }}-mbstring"
      - "php{{ php_version }}-xml"
      - "php{{ php_version }}-zip"
      - "php{{ php_version }}-bcmath"
      - "php{{ php_version }}-intl"
      - "php{{ php_version }}-ctype"
      - "php{{ php_version }}-gd"
      - "php{{ php_version }}-iconv"
      - "php{{ php_version }}-amqp"
      - "php{{ php_version }}-pgsql"
      - "php{{ php_version }}-readline"
      - "php{{ php_version }}-soap"
      - "php{{ php_version }}-sqlite3"
      - "php{{ php_version }}-gmp"
      - "php{{ php_version }}-dev"
      - "php-pear"
    state: present
  become: true

# - name: Install Redis extension via PECL
#   ansible.builtin.shell: |
#     printf "no\n" | pecl install redis
#   args:
#     creates: "/usr/lib/php/{{ php_version_short }}/redis.so"
#   become: true
#   register: pecl_redis_install

# - name: Enable Redis extension
#   ansible.builtin.lineinfile:
#     path: "/etc/php/{{ php_version }}/cli/php.ini"
#     line: "extension=redis.so"
#     state: present
#     create: false
#   become: true
#   when: pecl_redis_install.changed

- name: Check if Composer is installed
  ansible.builtin.stat:
    path: /usr/local/bin/composer
  register: composer_stat

- name: Download Composer installer
  ansible.builtin.get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/composer-installer.php
    checksum: "sha384:https://composer.github.io/installer.sig"
    mode: '0644'
    timeout: 30
  when: not composer_stat.stat.exists

- name: Install Composer
  ansible.builtin.command: >
    php /tmp/composer-installer.php --install-dir=/usr/local/bin --filename=composer --{{ composer_version }}
  args:
    creates: /usr/local/bin/composer
  become: true
  when: not composer_stat.stat.exists

- name: Check if Composer was actually installed
  ansible.builtin.stat:
    path: /usr/local/bin/composer
  register: composer_installed

- name: Set Composer executable permissions
  ansible.builtin.file:
    path: /usr/local/bin/composer
    mode: '0755'
  become: true
  when: composer_installed.stat.exists

- name: Verify PHP installation
  ansible.builtin.command: php --version
  register: php_version_output
  changed_when: false

- name: Display PHP version
  ansible.builtin.debug:
    msg: "PHP installed: {{ php_version_output.stdout_lines[0] }}"
  when: not ansible_check_mode and php_version_output.stdout_lines | length > 0

- name: Verify Composer installation
  ansible.builtin.command: composer --version
  register: composer_version_output
  changed_when: false

- name: Display Composer version
  ansible.builtin.debug:
    msg: "Composer installed: {{ composer_version_output.stdout_lines[0] }}"
  when: not ansible_check_mode and composer_version_output.stdout_lines | length > 0

- name: Check if Symfony CLI is installed
  ansible.builtin.stat:
    path: /usr/bin/symfony
  register: symfony_cli_stat

- name: Set up Symfony CLI repository
  ansible.builtin.shell: curl -1sLf 'https://dl.cloudsmith.io/public/symfony/stable/setup.deb.sh' | bash
  args:
    creates: /etc/apt/sources.list.d/symfony-stable.list
  become: true
  when: ansible_os_family == "Debian" and not symfony_cli_stat.stat.exists

- name: Install or update Symfony CLI
  ansible.builtin.apt:
    name: symfony-cli
    state: latest
    update_cache: true
  become: true
  when: ansible_os_family == "Debian"

- name: Verify Symfony CLI installation
  ansible.builtin.command: symfony version
  register: symfony_version_output
  changed_when: false
  failed_when: false

- name: Display Symfony CLI version
  ansible.builtin.debug:
    msg: "Symfony CLI installed: {{ symfony_version_output.stdout_lines[0] }}"
  when: not ansible_check_mode and symfony_version_output.rc == 0 and symfony_version_output.stdout_lines | length > 0
