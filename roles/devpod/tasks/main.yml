---
- name: Set architecture for DevPod
  ansible.builtin.set_fact:
    devpod_arch: "{{ arch_map[ansible_architecture] | default('amd64') }}"

- name: Set DevPod platform
  ansible.builtin.set_fact:
    devpod_platform: "{{ 'darwin' if ansible_os_family == 'Darwin' else 'linux' }}"

- name: Download DevPod CLI
  ansible.builtin.get_url:
    url: "https://github.com/loft-sh/devpod/releases/latest/download/devpod-{{ devpod_platform }}-{{ devpod_arch }}"
    dest: /tmp/devpod
    mode: '0755'
    timeout: 30

- name: Check if DevPod binary was downloaded
  ansible.builtin.stat:
    path: /tmp/devpod
  register: devpod_download_stat

- name: Install DevPod CLI
  ansible.builtin.copy:
    src: /tmp/devpod
    dest: /usr/local/bin/devpod
    remote_src: true
    mode: '0755'
  become: true
  when: devpod_download_stat.stat.exists

- name: Clean up downloaded DevPod binary
  ansible.builtin.file:
    path: /tmp/devpod
    state: absent

- name: Verify DevPod CLI installation
  ansible.builtin.command: devpod version
  register: devpod_version_output
  changed_when: false

- name: Display DevPod CLI version
  ansible.builtin.debug:
    msg: "DevPod CLI installed: {{ devpod_version_output.stdout }}"
  when: not ansible_check_mode and devpod_version_output.stdout | length > 0
