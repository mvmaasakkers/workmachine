---
- name: Set architecture for DevPod
  ansible.builtin.set_fact:
    devpod_arch: "{{ arch_map[ansible_architecture] | default('amd64') }}"

- name: Set DevPod platform
  ansible.builtin.set_fact:
    devpod_platform: "{{ 'darwin' if ansible_os_family == 'Darwin' else 'linux' }}"

- name: Check if DevPod CLI is already available (macOS)
  ansible.builtin.command: devpod version
  register: devpod_macos_check
  changed_when: false
  failed_when: false
  when: ansible_os_family == "Darwin"

- name: Install DevPod CLI (macOS)
  community.general.homebrew_cask:
    name: devpod
    state: present
  when: ansible_os_family == "Darwin" and devpod_macos_check.rc != 0

- name: Install DevPod CLI (Linux)
  when: ansible_os_family == "Debian"
  become: true
  block:
    - name: Download DevPod CLI binary
      ansible.builtin.get_url:
        url: "https://github.com/loft-sh/devpod/releases/latest/download/devpod-{{ devpod_platform }}-{{ devpod_arch }}"
        dest: /tmp/devpod-binary
        mode: '0755'
        timeout: 60

    - name: Install DevPod CLI to /usr/local/bin
      ansible.builtin.command:
        cmd: mv /tmp/devpod-binary /usr/local/bin/devpod
      changed_when: true

    - name: Set DevPod CLI permissions
      ansible.builtin.file:
        path: /usr/local/bin/devpod
        mode: '0755'

- name: Clean up stale /tmp/devpod if present
  ansible.builtin.file:
    path: /tmp/devpod
    state: absent

- name: Verify DevPod CLI installation
  ansible.builtin.command: devpod version
  register: devpod_version_output
  changed_when: false

- name: Display DevPod CLI version
  ansible.builtin.debug:
    msg: "DevPod CLI installed: {{ devpod_version_output.stdout }}"
  when: not ansible_check_mode and devpod_version_output.stdout | length > 0
