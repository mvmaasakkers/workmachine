---
# Node.js role - Install Node.js and npm

- name: Remove old NodeSource repository files
  ansible.builtin.file:
    path: "{{ nodejs_file }}"
    state: absent
  become: true
  loop:
    - /etc/apt/sources.list.d/nodesource.list
    - /etc/apt/keyrings/nodesource.gpg
  loop_control:
    loop_var: nodejs_file

- name: Download NodeSource setup script
  ansible.builtin.get_url:
    url: "https://deb.nodesource.com/setup_{{ nodejs_version }}.x"
    dest: /tmp/nodesource_setup.sh
    mode: '0755'

- name: Run NodeSource setup script
  ansible.builtin.command: bash /tmp/nodesource_setup.sh
  become: true
  changed_when: true

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  become: true

- name: Install Node.js
  ansible.builtin.package:
    name: nodejs
    state: present
  become: true

- name: Install build-essential for npm native modules
  ansible.builtin.package:
    name: build-essential
    state: present
  become: true

- name: Check if npm is available
  ansible.builtin.command: which npm
  register: npm_available
  changed_when: false
  failed_when: false

- name: Update npm to latest version
  community.general.npm:
    name: npm
    global: true
    state: present
  become: true
  when: not ansible_check_mode and npm_available.rc == 0

- name: Install common global npm packages
  community.general.npm:
    name: "{{ nodejs_package }}"
    global: true
    state: present
  become: true
  loop:
    - yarn
    - pnpm
    - typescript
    - ts-node
    - nodemon
  loop_control:
    loop_var: nodejs_package
  when: not ansible_check_mode and npm_available.rc == 0

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: node_version_output
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Node.js installed: {{ node_version_output.stdout }}"

- name: Verify npm installation
  ansible.builtin.command: npm --version
  register: npm_version_output
  changed_when: false

- name: Display npm version
  ansible.builtin.debug:
    msg: "npm installed: {{ npm_version_output.stdout }}"
