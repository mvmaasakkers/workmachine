---
# Node.js role - Install Node.js via nvm (cross-platform)

- name: Check if nvm is already installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.nvm/nvm.sh"
  register: nvm_installed

- name: Install nvm
  ansible.builtin.shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
  args:
    creates: "{{ ansible_env.HOME }}/.nvm/nvm.sh"
  when: not nvm_installed.stat.exists

- name: Ensure nvm is sourced in .zshrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - nvm"
    block: |
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
    create: true
    mode: '0644'

- name: Ensure nvm is sourced in .bashrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - nvm"
    block: |
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
    create: true
    mode: '0644'

- name: Install Node.js via nvm
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    . "$NVM_DIR/nvm.sh"
    nvm install {{ nodejs_version }}
  args:
    executable: /bin/bash
  register: nvm_install_result
  changed_when: "'is already installed' not in nvm_install_result.stderr"

- name: Set default Node.js version
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    . "$NVM_DIR/nvm.sh"
    nvm alias default {{ nodejs_version }}
  args:
    executable: /bin/bash
  changed_when: false

- name: Get Node.js version
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    . "$NVM_DIR/nvm.sh"
    node --version
  args:
    executable: /bin/bash
  register: node_version_output
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Node.js installed: {{ node_version_output.stdout }}"

- name: Get npm version
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    . "$NVM_DIR/nvm.sh"
    npm --version
  args:
    executable: /bin/bash
  register: npm_version_output
  changed_when: false

- name: Display npm version
  ansible.builtin.debug:
    msg: "npm installed: {{ npm_version_output.stdout }}"

- name: Install common global npm packages
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    . "$NVM_DIR/nvm.sh"
    npm install -g {{ nodejs_package }}
  args:
    executable: /bin/bash
  loop:
    - yarn
    - pnpm
    - typescript
    - typescript-language-server
    - ts-node
    - nodemon
  loop_control:
    loop_var: nodejs_package
  register: npm_install_result
  changed_when: "'added' in npm_install_result.stdout or 'up to date' not in npm_install_result.stdout"
  when: not ansible_check_mode

# Install Bun (cross-platform JavaScript runtime and toolkit)
- name: Check if Bun is already installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.bun/bin/bun"
  register: bun_installed

- name: Install Bun
  ansible.builtin.shell: |
    curl -fsSL https://bun.sh/install | bash
  args:
    creates: "{{ ansible_env.HOME }}/.bun/bin/bun"
  environment:
    BUN_INSTALL: "{{ ansible_env.HOME }}/.bun"
  when: not bun_installed.stat.exists

- name: Ensure Bun PATH in .zshrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    line: 'export PATH="$HOME/.bun/bin:$PATH"'
    state: present
    create: true
    mode: '0644'

- name: Ensure Bun PATH in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: 'export PATH="$HOME/.bun/bin:$PATH"'
    state: present
    create: true
    mode: '0644'

- name: Get Bun version
  ansible.builtin.command: "{{ ansible_env.HOME }}/.bun/bin/bun --version"
  register: bun_version_output
  changed_when: false
  failed_when: false

- name: Display Bun version
  ansible.builtin.debug:
    msg: "Bun installed: {{ bun_version_output.stdout }}"
  when: bun_version_output.rc == 0 and bun_version_output.stdout | length > 0
