---
# Node.js role - Install Node.js and npm

- name: Remove old NodeSource repository files (Linux)
  ansible.builtin.file:
    path: "{{ nodejs_file }}"
    state: absent
  become: true
  loop:
    - /etc/apt/sources.list.d/nodesource.list
    - /etc/apt/keyrings/nodesource.gpg
  loop_control:
    loop_var: nodejs_file
  when: ansible_os_family == "Debian"

- name: Download NodeSource setup script (Linux)
  ansible.builtin.get_url:
    url: "https://deb.nodesource.com/setup_{{ nodejs_version }}.x"
    dest: /tmp/nodesource_setup.sh
    mode: '0755'
  when: ansible_os_family == "Debian"

- name: Run NodeSource setup script (Linux)
  ansible.builtin.command: bash /tmp/nodesource_setup.sh
  become: true
  changed_when: true
  when: ansible_os_family == "Debian"

- name: Update apt cache (Linux)
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: ansible_os_family == "Debian"

- name: Install Node.js (Linux)
  ansible.builtin.package:
    name: nodejs
    state: present
  become: true
  when: ansible_os_family == "Debian"

- name: Install build-essential for npm native modules (Linux)
  ansible.builtin.package:
    name: build-essential
    state: present
  become: true
  when: ansible_os_family == "Debian"

- name: Install Node.js (macOS)
  community.general.homebrew:
    name: "node@{{ nodejs_version }}"
    state: present
  when: ansible_os_family == "Darwin"

- name: Link Node.js (macOS)
  ansible.builtin.command: "brew link node@{{ nodejs_version }} --force --overwrite"
  when: ansible_os_family == "Darwin"
  changed_when: false
  failed_when: false

- name: Check if npm is available
  ansible.builtin.command: which npm
  register: npm_available
  changed_when: false
  failed_when: false

- name: Update npm to latest version
  community.general.npm:
    name: npm
    global: true
    state: present
  become: true
  when: not ansible_check_mode and npm_available.rc == 0

- name: Install common global npm packages
  community.general.npm:
    name: "{{ nodejs_package }}"
    global: true
    state: present
  become: true
  loop:
    - yarn
    - pnpm
    - typescript
    - ts-node
    - nodemon
  loop_control:
    loop_var: nodejs_package
  when: not ansible_check_mode and npm_available.rc == 0

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: node_version_output
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Node.js installed: {{ node_version_output.stdout }}"

- name: Verify npm installation
  ansible.builtin.command: npm --version
  register: npm_version_output
  changed_when: false

- name: Display npm version
  ansible.builtin.debug:
    msg: "npm installed: {{ npm_version_output.stdout }}"

# Install Bun (cross-platform JavaScript runtime and toolkit)
- name: Check if Bun is already installed
  ansible.builtin.command: which bun
  register: bun_available
  changed_when: false
  failed_when: false

- name: Install Bun (Linux/macOS)
  ansible.builtin.shell: |
    curl -fsSL https://bun.sh/install | bash
  args:
    creates: "{{ ansible_env.HOME }}/.bun/bin/bun"
  environment:
    BUN_INSTALL: "{{ ansible_env.HOME }}/.bun"
  when: bun_available.rc != 0

- name: Add Bun to PATH in .zshrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    line: 'export PATH="$HOME/.bun/bin:$PATH"'
    state: present
    create: true
    mode: '0644'
  when: bun_available.rc != 0

- name: Add Bun to PATH in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: 'export PATH="$HOME/.bun/bin:$PATH"'
    state: present
    create: true
    mode: '0644'
  when: bun_available.rc != 0

- name: Verify Bun installation
  ansible.builtin.command: "{{ ansible_env.HOME }}/.bun/bin/bun --version"
  register: bun_version_output
  changed_when: false
  failed_when: false

- name: Display Bun version
  ansible.builtin.debug:
    msg: "Bun installed: {{ bun_version_output.stdout }}"
  when: bun_version_output.rc == 0 and bun_version_output.stdout | length > 0
