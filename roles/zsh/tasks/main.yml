---
# Zsh role - Install zsh and oh-my-zsh with Powerline fonts

- name: Install zsh and font dependencies
  ansible.builtin.package:
    name:
      - zsh
      - fontconfig
      - fonts-powerline
    state: present
  become: true

- name: Check if oh-my-zsh is already installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh"
  register: ohmyzsh_stat

- name: Download oh-my-zsh installer
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
    dest: /tmp/install-ohmyzsh.sh
    mode: '0755'
    force: true
    timeout: 30
  when: not ohmyzsh_stat.stat.exists
  register: ohmyzsh_download

- name: Install oh-my-zsh
  ansible.builtin.shell: |
    sh /tmp/install-ohmyzsh.sh --unattended
  args:
    creates: "{{ ansible_env.HOME }}/.oh-my-zsh"
  environment:
    RUNZSH: 'no'
    CHSH: 'no'

- name: Check if zsh config directory exists
  ansible.builtin.stat:
    path: "{{ zsh_config_dir }}"
  register: zsh_config_stat

- name: Check if zsh config is a git repo
  ansible.builtin.stat:
    path: "{{ zsh_config_dir }}/.git"
  register: zsh_config_git_stat

- name: Remove existing zsh config directory if not a git repo
  ansible.builtin.file:
    path: "{{ zsh_config_dir }}"
    state: absent
  when: zsh_config_stat.stat.exists and not zsh_config_git_stat.stat.exists

- name: Clone zsh configuration repository
  ansible.builtin.git:
    repo: git@github.com:mvmaasakkers/zsh.git
    dest: "{{ zsh_config_dir }}"
    accept_hostkey: true
    update: true

- name: Remove oh-my-zsh generated .zshrc
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.zshrc"
    state: absent

- name: Create symlink from ~/.zshrc to config repo
  ansible.builtin.file:
    src: "{{ zsh_config_dir }}/.zshrc"
    dest: "{{ ansible_env.HOME }}/.zshrc"
    state: link

- name: Change default shell to zsh
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    shell: /usr/bin/zsh
  become: true

- name: Create VS Code Server data directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.vscode-server/data/Machine"
    state: directory
    mode: '0755'

- name: Configure VS Code Remote to use zsh
  ansible.builtin.copy:
    dest: "{{ ansible_env.HOME }}/.vscode-server/data/Machine/settings.json"
    content: |
      {
        "terminal.integrated.defaultProfile.linux": "zsh"
      }
    mode: '0644'
    force: false
