---
# Zsh role - Install zsh and oh-my-zsh with Nerd Fonts

- name: Install zsh and font dependencies (Linux)
  ansible.builtin.package:
    name:
      - zsh
      - fontconfig
      - fonts-powerline
      - unzip
      - wget
    state: present
  become: true
  when: ansible_os_family == "Debian"

- name: Install zsh and dependencies (macOS)
  community.general.homebrew:
    name:
      - zsh
      - wget
    state: present
  when: ansible_os_family == "Darwin"

- name: Create fonts directory
  ansible.builtin.file:
    path: "{{ font_dir }}"
    state: directory
    mode: '0755'

- name: Check if Nerd Fonts are already installed
  ansible.builtin.stat:
    path: "{{ font_dir }}/NerdFonts"
  register: nerd_fonts_stat

- name: Download and install Nerd Fonts (Hack, Meslo, FiraCode, JetBrainsMono)
  when: not nerd_fonts_stat.stat.exists
  block:
    - name: Create temporary directory for fonts
      ansible.builtin.tempfile:
        state: directory
        suffix: nerdfonts
      register: fonts_temp_dir

    - name: Download Hack Nerd Font
      ansible.builtin.get_url:
        url: "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Hack.zip"
        dest: "{{ fonts_temp_dir.path | default('/tmp') }}/Hack.zip"
        mode: '0644'
        timeout: 60
      register: hack_download
      failed_when: hack_download is failed and 'HTTP Error 404' not in (hack_download.msg | default(''))

    - name: Download Meslo Nerd Font
      ansible.builtin.get_url:
        url: "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Meslo.zip"
        dest: "{{ fonts_temp_dir.path | default('/tmp') }}/Meslo.zip"
        mode: '0644'
        timeout: 60
      register: meslo_download
      failed_when: meslo_download is failed and 'HTTP Error 404' not in (meslo_download.msg | default(''))

    - name: Download FiraCode Nerd Font
      ansible.builtin.get_url:
        url: "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/FiraCode.zip"
        dest: "{{ fonts_temp_dir.path | default('/tmp') }}/FiraCode.zip"
        mode: '0644'
        timeout: 60
      register: firacode_download
      failed_when: firacode_download is failed and 'HTTP Error 404' not in (firacode_download.msg | default(''))

    - name: Download JetBrainsMono Nerd Font
      ansible.builtin.get_url:
        url: "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip"
        dest: "{{ fonts_temp_dir.path | default('/tmp') }}/JetBrainsMono.zip"
        mode: '0644'
        timeout: 60
      register: jetbrains_download
      failed_when: jetbrains_download is failed and 'HTTP Error 404' not in (jetbrains_download.msg | default(''))

    - name: Create NerdFonts directory
      ansible.builtin.file:
        path: "{{ font_dir }}/NerdFonts"
        state: directory
        mode: '0755'
      register: nerd_fonts_dir_created

    - name: Extract Hack Nerd Font
      ansible.builtin.unarchive:
        src: "{{ fonts_temp_dir.path | default('/tmp') }}/Hack.zip"
        dest: "{{ font_dir }}/NerdFonts"
        remote_src: true
      when: hack_download is succeeded and not ansible_check_mode

    - name: Extract Meslo Nerd Font
      ansible.builtin.unarchive:
        src: "{{ fonts_temp_dir.path | default('/tmp') }}/Meslo.zip"
        dest: "{{ font_dir }}/NerdFonts"
        remote_src: true
      when: meslo_download is succeeded and not ansible_check_mode

    - name: Extract FiraCode Nerd Font
      ansible.builtin.unarchive:
        src: "{{ fonts_temp_dir.path | default('/tmp') }}/FiraCode.zip"
        dest: "{{ font_dir }}/NerdFonts"
        remote_src: true
      when: firacode_download is succeeded and not ansible_check_mode

    - name: Extract JetBrainsMono Nerd Font
      ansible.builtin.unarchive:
        src: "{{ fonts_temp_dir.path | default('/tmp') }}/JetBrainsMono.zip"
        dest: "{{ font_dir }}/NerdFonts"
        remote_src: true
      when: jetbrains_download is succeeded and not ansible_check_mode

    - name: Clean up temporary font files
      ansible.builtin.file:
        path: "{{ fonts_temp_dir.path | default('/tmp/nerdfonts') }}"
        state: absent
      when: fonts_temp_dir.path is defined

- name: Update font cache (Linux only)
  ansible.builtin.command: fc-cache -fv
  changed_when: false
  when: ansible_os_family == "Debian"

- name: Check if oh-my-zsh is already installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh"
  register: ohmyzsh_stat

- name: Download oh-my-zsh installer
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
    dest: /tmp/install-ohmyzsh.sh
    mode: '0755'
    force: true
    timeout: 30
  when: not ohmyzsh_stat.stat.exists
  register: ohmyzsh_download

- name: Install oh-my-zsh
  ansible.builtin.shell: |
    sh /tmp/install-ohmyzsh.sh --unattended
  args:
    creates: "{{ ansible_env.HOME }}/.oh-my-zsh"
  environment:
    RUNZSH: 'no'
    CHSH: 'no'

- name: Deploy zsh configuration
  ansible.builtin.copy:
    src: files/
    dest: "{{ zsh_config_dir }}/"
    mode: preserve

- name: Remove oh-my-zsh generated .zshrc
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.zshrc"
    state: absent

- name: Check if zsh config .zshrc exists
  ansible.builtin.stat:
    path: "{{ zsh_config_dir }}/.zshrc"
  register: zsh_config_zshrc_stat

- name: Create symlink from ~/.zshrc to config repo
  ansible.builtin.file:
    src: "{{ zsh_config_dir }}/.zshrc"
    dest: "{{ ansible_env.HOME }}/.zshrc"
    state: link
  when: zsh_config_zshrc_stat.stat.exists

- name: Get zsh path
  ansible.builtin.command: which zsh
  register: zsh_path_result
  changed_when: false

- name: Check if shell is already zsh
  ansible.builtin.shell: "echo $SHELL"
  register: current_shell_result
  changed_when: false
  check_mode: false

- name: Change default shell to zsh
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    shell: "{{ zsh_path_result.stdout }}"
  become: true
  when: "'zsh' not in (current_shell_result.stdout | default(''))"

- name: Create VS Code Server data directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.vscode-server/data/Machine"
    state: directory
    mode: '0755'

- name: Configure VS Code Remote to use zsh
  ansible.builtin.copy:
    dest: "{{ ansible_env.HOME }}/.vscode-server/data/Machine/settings.json"
    content: |
      {
        "terminal.integrated.defaultProfile.linux": "zsh"
      }
    mode: '0644'
    force: false
