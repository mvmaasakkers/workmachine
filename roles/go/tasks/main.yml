---
# Go role - Install Go programming language

- name: Check if Go is already installed
  ansible.builtin.stat:
    path: "{{ go_install_dir }}/go/bin/go"
  register: go_binary

- name: Get installed Go version
  ansible.builtin.command: "{{ go_install_dir }}/go/bin/go version"
  register: installed_go_version
  changed_when: false
  failed_when: false
  check_mode: false
  when: go_binary.stat.exists

- name: Debug Go version check
  ansible.builtin.debug:
    msg: "Binary exists: {{ go_binary.stat.exists }}, Installed version: '{{ installed_go_version.stdout | default('N/A') }}', Target version: '{{ go_version }}'"

- name: Set Go needs installation flag
  ansible.builtin.set_fact:
    go_needs_install: "{{ not go_binary.stat.exists or go_version not in (installed_go_version.stdout | default('')) }}"

- name: Set Go platform
  ansible.builtin.set_fact:
    go_platform: "{{ 'darwin' if ansible_os_family == 'Darwin' else 'linux' }}"

- name: Fetch and parse Go versions JSON to get checksum
  ansible.builtin.shell: |
    curl -s 'https://go.dev/dl/?mode=json' | \
    jq -r '.[] | select(.version == "go{{ go_version }}") | .files[] | select(.filename == "go{{ go_version }}.{{ go_platform }}-{{ go_arch }}.tar.gz") | .sha256' | head -1
  register: go_checksum_result
  changed_when: false
  check_mode: false
  when: go_needs_install

- name: Debug Go checksum result
  ansible.builtin.debug:
    msg: "Go checksum fetch result: stdout='{{ go_checksum_result.stdout | default('UNDEFINED') }}' rc={{ go_checksum_result.rc | default('UNDEFINED') }}"
  when: go_needs_install

- name: Check if Go version exists
  ansible.builtin.fail:
    msg: "Go version {{ go_version }} not found. Please update go_version in vars.yml to a valid version. Check https://go.dev/dl/ for available versions."
  when: go_needs_install and (go_checksum_result.stdout is not defined or go_checksum_result.stdout | length == 0)

- name: Set Go checksum variable
  ansible.builtin.set_fact:
    go_checksum: "{{ go_checksum_result.stdout }}"
  when: go_needs_install and go_checksum_result.stdout | length > 0

- name: Download Go tarball
  ansible.builtin.get_url:
    url: "https://go.dev/dl/go{{ go_version }}.{{ go_platform }}-{{ go_arch }}.tar.gz"
    dest: "/tmp/go{{ go_version }}.{{ go_platform }}-{{ go_arch }}.tar.gz"
    checksum: "sha256:{{ go_checksum }}"
    mode: '0644'
    timeout: 60
  when: go_needs_install and go_checksum is defined and go_checksum | length > 0

- name: Remove old Go installation
  ansible.builtin.file:
    path: "{{ go_install_dir }}/go"
    state: absent
  become: true
  when: go_needs_install

- name: Check if Go tarball was downloaded
  ansible.builtin.stat:
    path: "/tmp/go{{ go_version }}.{{ go_platform }}-{{ go_arch }}.tar.gz"
  register: go_tarball_stat

- name: Extract Go tarball
  ansible.builtin.command:
    cmd: tar -xzf "/tmp/go{{ go_version }}.{{ go_platform }}-{{ go_arch }}.tar.gz" -C "{{ go_install_dir }}"
  become: true
  when: go_needs_install and go_tarball_stat.stat.exists
  changed_when: true

- name: Add Go to PATH in .zshrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Go"
    block: |
      export GOROOT={{ go_install_dir }}/go
      export GOPATH=$HOME/go
      export PATH=$PATH:$GOROOT/bin:$GOPATH/bin
    create: true
    mode: '0644'

- name: Add Go to PATH in .bashrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Go"
    block: |
      export GOROOT={{ go_install_dir }}/go
      export GOPATH=$HOME/go
      export PATH=$PATH:$GOROOT/bin:$GOPATH/bin
    create: true
    mode: '0644'

- name: Create GOPATH directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/go"
    state: directory
    mode: '0755'

- name: Verify Go installation
  ansible.builtin.command: "{{ go_install_dir }}/go/bin/go version"
  register: go_version_output
  changed_when: false
  failed_when: false

- name: Display Go version
  ansible.builtin.debug:
    msg: "Go installed: {{ go_version_output.stdout }}"
  when: go_version_output.rc == 0

- name: Display Go installation error
  ansible.builtin.debug:
    msg: "WARNING: Go installation verification failed. Go may not be installed correctly."
  when: go_version_output.rc != 0
