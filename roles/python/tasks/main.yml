---
# Python role - Install Python and pip (PEP 668 compliant)

- name: Install Python (macOS)
  community.general.homebrew:
    name: "python@{{ python_version }}"
    state: present
  when: ansible_os_family == "Darwin" and python_version is defined

- name: Install pipx (macOS)
  community.general.homebrew:
    name: pipx
    state: present
  when: ansible_os_family == "Darwin"

- name: Add deadsnakes PPA for specific Python versions (Ubuntu/Pop!_OS)
  ansible.builtin.apt_repository:
    repo: ppa:deadsnakes/ppa
    state: present
  become: true
  when:
    - ansible_distribution in ["Ubuntu", "Pop!_OS"]
    - python_version is defined

- name: Update apt cache (Linux)
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: ansible_os_family == "Debian" and python_version is defined

- name: Install specific Python version and development tools (Linux)
  ansible.builtin.package:
    name:
      - "python{{ python_version }}"
      - "python{{ python_version }}-dev"
      - "python{{ python_version }}-venv"
      - python3-pip
      - python-is-python3
      - pipx
    state: present
  become: true
  when: ansible_os_family == "Debian" and python_version is defined

- name: Install distutils for Python < 3.12
  ansible.builtin.package:
    name:
      - "python{{ python_version }}-distutils"
    state: present
  become: true
  when:
    - python_version is defined
    - python_version is version('3.12', '<')
  register: distutils_result
  failed_when: distutils_result is failed and
    ('Unable to locate package' not in (distutils_result.msg | default('')) and
    'Unable to locate package' not in (distutils_result.stderr | default('')))

- name: Install default Python 3 and development tools (Linux)
  ansible.builtin.package:
    name:
      - python3
      - python3-pip
      - python3-dev
      - python3-venv
      - python3-full
      - python-is-python3
      - pipx
    state: present
  become: true
  when: ansible_os_family == "Debian" and python_version is not defined

- name: Ensure pipx path is configured
  ansible.builtin.command: pipx ensurepath
  register: pipx_ensurepath
  changed_when: "'already in PATH' not in pipx_ensurepath.stdout"
  failed_when: false

- name: Install common Python tools via apt (PEP 668 compliant)
  ansible.builtin.package:
    name:
      - python3-setuptools
      - python3-wheel
      - python3-virtualenv
      - python3-pytest
    state: present
  become: true

- name: Check if poetry is installed
  ansible.builtin.command: pipx list
  register: pipx_list
  changed_when: false
  failed_when: false

- name: Install Python development tools via pipx
  ansible.builtin.command: pipx install {{ python_tool }}
  loop:
    - poetry
    - pipenv
    - black
    - flake8
    - pylint
    - virtualenvwrapper
  loop_control:
    loop_var: python_tool
  when: python_tool not in pipx_list.stdout
  register: pipx_install
  changed_when: pipx_install.rc == 0
  failed_when: false

- name: Verify specific Python version installation
  ansible.builtin.command: "python{{ python_version }} --version"
  register: python_specific_version_output
  changed_when: false
  when: python_version is defined

- name: Verify default Python installation
  ansible.builtin.command: python3 --version
  register: python_default_version_output
  changed_when: false
  when: python_version is not defined

- name: Display specific Python version
  ansible.builtin.debug:
    msg: "Python installed: {{ python_specific_version_output.stdout }}"
  when: python_version is defined

- name: Display default Python version
  ansible.builtin.debug:
    msg: "Python installed: {{ python_default_version_output.stdout }}"
  when: python_version is not defined

- name: Verify pip installation
  ansible.builtin.command: pip3 --version
  register: pip_version_output
  changed_when: false

- name: Display pip version
  ansible.builtin.debug:
    msg: "pip installed: {{ pip_version_output.stdout }}"
