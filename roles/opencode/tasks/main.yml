---
- name: Install OpenCode CLI globally via npm
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    . "$NVM_DIR/nvm.sh"
    npm install -g opencode-ai
  args:
    executable: /bin/bash
  register: opencode_install_result
  changed_when: "'added' in opencode_install_result.stdout or 'up to date' not in opencode_install_result.stdout"
  when: not ansible_check_mode

- name: Verify OpenCode CLI installation
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    . "$NVM_DIR/nvm.sh"
    opencode --version
  args:
    executable: /bin/bash
  register: opencode_version_output
  changed_when: false
  failed_when: false

- name: Display OpenCode CLI version
  ansible.builtin.debug:
    msg: "OpenCode CLI installed: {{ opencode_version_output.stdout }}"
  when: not ansible_check_mode and opencode_version_output.stdout | length > 0

- name: Install Oh My OpenCode plugin globally via npm
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    . "$NVM_DIR/nvm.sh"
    npm install -g @reinamaccredy/oh-my-opencode
  args:
    executable: /bin/bash
  register: omo_install_result
  changed_when: "'added' in omo_install_result.stdout or 'up to date' not in omo_install_result.stdout"
  when: not ansible_check_mode

- name: Display Oh My OpenCode installation status
  ansible.builtin.debug:
    msg: "Oh My OpenCode plugin installed. Configure in ~/.config/opencode/opencode.json"
  when: not ansible_check_mode
